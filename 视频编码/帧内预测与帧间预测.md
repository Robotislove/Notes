# 帧内预测与帧间预测

## 帧内预测
在帧内预测模式中，预测块P是基于已编码重建块和当前块形成的。

对亮度像素而言，P块用于4×4子块或者16×16宏块的相关操作。4×4亮度子块有9种可选预测模式，独立预测每一个4×4亮度子块，适用于带有大量细节的图像编码；16×16亮度块有4种预测模式，预测整个16×16亮度块，适用于平坦区域图像编码；色度块也有4种预测模式，类似于16×16亮度块预测模式。编码器通常选择使P块和编码块之间差异最小的预测模式。

此外，H.264还有一种帧内编码模式I_PCM，该模式允许编码器直接传输图像的像素值，而不经过预测和变换。在一些特殊的情况下，特别是图像内容不规则或者量化参数非常低时，该模式比起“常规操作”（帧内预测-变换-量化-熵编码）效率更高。I_PCM模式用于以下目的：
1. 允许编码器精确地表示像素值；
2. 提供表示不规则图像内容的准确值，而不引起重大的数据量增加；
3. 严格限制宏块解码比特数，但不损害编码效率。

## 帧间预测
帧间预测的基本原理：利用相邻的已经编码的图像为当前编码块寻找最佳匹配块，把这个最佳匹配块作为当前块的预测值，然后将预测值和当前块的原始像素值相减，得到当前块的残差值，后续的变换、量化等操作都是基于残差值进行的。

运动估计(Motion Estimation, ME)：（MV向量级概念），为当前图像的每个像素块在之前已编码图像中寻找一个最佳匹配块，利用快匹配算法，在参考帧中搜索与当前块最相似的块，搜索出来后会**返回当前块的MV（帧间预测通常优化的部分）**。

MV预测，很多时候我们需要使用利相邻块的MV来预测当前块的MV，得到的叫做预测MV（即MVp）作为对当前块的预测。

运动补偿：（像素级概念），利用运动估计得到的MV，参考帧索引等运动信息，重建得到预测块的过程。

**编码端：MVD（传递残差MVD）=MV（运动估计得到）-MVp（通过邻近块MV预测得到）**  
**解码端：MV=MVD（编码端传入）+MVp（解码端邻近块预测）->若编码端修改运动估计方法，只会影响传给解码端的MVD，则解码端也可以用MVD恢复出MV。**

**得到MV后，再找到相应的参考宏块，将块像素赋给当前帧，得到预测像素值。**  
**重建像素=像素残差（编码端传入）+预测像素**

![mv](https://raw.githubusercontent.com/lhondong/PicGo/main/img/mv.png)

### 编码端
1. 在t-1帧（参考帧）中**通过运动搜索，找出mb2（当前编码块）的最佳匹配块mb1**，则可由mb1, mb2的位置信息得出运动向量MV（红线）
2. 在t帧（当前帧）中，由于相邻宏块MV有较强的相关性，可由已编码相邻宏块（绿色块1, 2, 3）的MV得到mb2的运动向量预测，如MVp=(MV1+MV2+MV3)/3
3. MVD（实际传输的残差MVD）=MV（运动估计得到）-MVp（通过邻近块MV预测得到）
4. 通过运动补偿可得到mb2的像素预测值，将其与真实像素值的差值作为码流的一部分传给解码端

### 解码端
1. 在t帧中，由已编码相邻宏块（绿色块1, 2, 3）的MV得到mb2的运动向量预测  MVp=(MV1+MV2+MV3)/3
2. MV=MVD（编码端传入）+MVp（解码端邻近块预测）
3. 得到mb2的MV，已知参考帧为t-1，可在t-1中，**通过MV找到mb2的匹配块mb1**，将mb1的像素值赋给mb2，则得到mb2的像素重建值。
4. 重建像素=像素残差（编码端传入）+预测像素