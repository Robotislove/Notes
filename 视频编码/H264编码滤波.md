# H264编码滤波

我们可以把滤波理解为一个在量化值波动特别大的时候的一个提升主观质量的操作。如果量化值波动特别大，有可能造成本不应该是真实边界的区域内有很明显的块效应。我们暂称为块效应边界。

真实边缘就比如说我们人脸和身后的背景，中间的这一条线。那假边界就是图中人脸区域的一个一个小块当中的这样的一个线。

为了优化这种情况我们需要对块效应边界两边的值进行补偿操作，让块效应边界两边的值差异不要过大，从而降低块效应，提升质量。

具体的操作，我们分三步。我会细致给大家梳理下。这部分很重要，有需要或者感兴趣的同学可以参考：

## 1. 初步估算块效应边界强度。
我们首先需要粗略的估计块效应边界像素的差距，我们称这个像素差距为边界强度。一共有0到4这五种强度，其中0代表最弱的强度，是估算两边像素相差不大，不需要进行滤波。4代表最强的强度，也就是估算两边像素相差可能巨大。

初步估算块效应边界强度:

4：边界两边块是帧内预测且块边缘是所在宏块边缘  
3：边界两边块是帧内预测且块边缘  
2：边界两边块的残差变换系数包含非零系数  
1：边界两边块的残差变换系数不包含非零系数，且两块的参考帧或运动向量不同  
0：边界两边块的残差变换系数不包含非零系数，且两块的参考帧或运动向量相同  

## 2. 区分真假边界。
我们应该进行滤波操作的边界是块效应边界，这样的边界我们称为假边界，而真实的物体边界我们是不应该做滤波的。

标准H.264中设定了两个阈值，块与块之间的边界阈值和块内部边界的阈值，用这两个阈值对边界周围一共四个像素做三次条件判断，三个条件同时满足我们才认定他是虚假边界需要做滤波。我们可以看到在决定阈值的过程中还有一个滤波强度的偏移量，我们可以手动调节其大小来更精细的判定当前块到底是需要保存细节，还是存在块效应应该被优化。
a. 初步估算边界强度：

4：边界两边块是帧内预测且块边缘是所在宏块边缘  
3：边界两边块是帧内预测且块边缘  
2：边界两边块的残差变换系数包含非零系数  
1：边界两边块的残差变换系数不包含非零系数，且两块的参考帧或运动向量不同  
0：边界两边块的残差变换系数不包含非零系数，且两块的参考帧或运动向量相同  

b. 区分真假边界（假设p0和q0直线的边界是判断边界，三个都满足就是虚假边界是需要滤波的）：

![p1](https://raw.githubusercontent.com/lhondong/PicGo/main/img/p1.png)

$|p0 - q0| < 块与块之间的边界阈值 = Clip3( 0, 51, ( QPp+QPq+1) / 2+ 滤波强度偏移量)$  
$|p1 - p0| < 块内部边界的阈值 = Clip3( 0, 51, ( QPp+QPq+1) / 2+ 滤波强度偏移量)$  
$|q1 - q0| < 块内部边界的阈值 = Clip3( 0, 51, ( QPp+QPq+1) / 2+ 滤波强度偏移量)$  
增加滤波强度时，用正偏移量，可以去除由次优运动估计、编码模式选择不当引起的块效应，改善图像主观质量；减少滤波强度时，用负偏移量，可以保护图像细节不被滤波器的平滑作用模糊掉。

## 3. 计算差值。
对边界两边的值进行补偿，边界强度1到3对应弱滤波器，首先将p0、q0两个像素点进行补偿，接着用内部边界的阈值判断是否需要调整p1和q1，边界强度4对应强滤波器，强滤波器对（p0、p1、p2、q0、q1、q2）一共6个像素点进行补偿。

计算：（强滤波器，弱滤波器）：得到差值（限制查标准）
$Δ = ( p2 + ((p0+q0+1)>>1) − (p1<<1)) >> 1$  
对边界两边的点对这个差值做对应的加或减
